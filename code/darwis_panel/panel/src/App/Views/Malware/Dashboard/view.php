<?php

/**
 * Copyright (c) 2022 Cyber Security & Privacy Foundation Pte. Ltd.- All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Cyber Security & Privacy Foundation Pte. Ltd.
 */

use Core\View;

?>

<!-- <script src="/resources/new-theme/vendor/chart.js/js/chart.min.js"></script> -->
<!-- <script src="/resources/vendor/chartjs/4.2.1/js/chart.umd.js"></script> -->
<script src="/resources/vendor/chartjs/4.4.1/js/chart.umd.js"></script>

<style>
    .chart-container {
        position: relative;
        height: 60vh;
        width: 60vh;
    }

    @media (max-width: 767.98px) {
        .chart-container {
            width: 300px;
            margin: auto;
        }

    }
</style>

<script>
    const newMalwareColor = "#D36086";
    const maliciousColor = "#9170B8";
    const cleanColor = "#54B399";
    const whitelistColor = "#6092C0";
    const emptyColor = "#efefef";
</script>

<div class="row">

    <div class="col-lg-8 mx-auto card mt-4 mb-4 p-2">
        <div class="card-header">
            <h3>Honeypot Statistics</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-lg-2 my-auto">
                    From Date
                </div>
                <div class="col-lg-3 col-sm-12">
                    <input type="date" class="datepicker form-control" id="honeypot-start-date" value="" />
                </div>
                <div class="col-lg-2 my-auto">
                    To Date
                </div>
                <div class="col-lg-3 col-sm-12">
                    <input type="date" class="  datepicker form-control" id="honeypot-end-date" value="" />
                </div>
            </div>

            <div class="row  mx-auto mt-2">
                <div class="col-lg-2"></div>

                <button id="stats-refresh" <?= isset($disable_buttons) && $disable_buttons ? 'disabled' : '' ?> type="button" class="mx-1 col-lg-4 col-sm-12 btn btn-info text-white mb-2 ">REFRESH CHART
                </button>
                <button id="stats-details" <?= isset($disable_buttons) && $disable_buttons ? 'disabled' : '' ?> type="button" class="mx-1 col-lg-4 col-sm-12 btn btn-info text-white mb-2">VIEW DETAILS
                </button>

                <div class="col-lg-8 mx-auto">
                    <div class="mx-auto chart-container ">
                        <canvas id="honeypot-stats-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    let emptyData = true;
    <?php if (isset($empty_data) && !$empty_data) : ?>
        emptyData = false;
    <?php endif; ?>

    document.getElementById("honeypot-start-date").value = "<?php View::securePrint($honeypot_start_date->format("Y-m-d")); ?>";
    document.getElementById("honeypot-end-date").value = "<?php View::securePrint($honeypot_end_date->format("Y-m-d")); ?>";
</script>


<script>
    $(document).ready(function() {
        let chart_id = 'honeypot-stats-chart';
        let honeypotMinimumStartDate = null;
        <?php if (isset($honeypot_first_record_date) && $honeypot_first_record_date) : ?>
            honeypotMinimumStartDate = new Date("<?php View::securePrint($honeypot_first_record_date->format("Y/m/d H:i:s")); ?>");

            // document.getElementById("honeypot-start-date").setAttribute('min', "<?php View::securePrint($honeypot_first_record_date->format("Y")); ?>");

        <?php endif; ?>

        // ************* Honeypot Stats PieChart *************
        var honeypot_stats_ctx = document.getElementById(chart_id)

        var labels = []
        var data = []
        var bgColor = [
            newMalwareColor,
            maliciousColor,
            cleanColor,
            whitelistColor,
            emptyColor,
        ];
        <?php foreach ($honeypot_stats as $label => $value) : ?>
            labels.push("<?php View::securePrint($label); ?>")
            data.push("<?php View::securePrint($value); ?>")
        <?php endforeach; ?>

        if (emptyData) {
            <?= isset($invalid_key) && $invalid_key ? 'labels.push("No Data (Invalid API Key)");' : 'labels.push("No data yet");' ?>;
            data.push(1);
        }

        // pie chart data
        var honeypot_stats_data = {
            labels: labels,
            datasets: [{
                label: "Honeypot Statistics",
                data: data,
                backgroundColor: bgColor,
                borderWidth: [1.8, 1.8, 1.8, 1.8, 1.8],
            }]
        };

        // options
        var honeypot_stats_options = {
            responsive: true,
            cutoutPercentage: 70,
            title: {
                display: true,
                position: "top",
                text: "Honeypot Statistics (" + $("#honeypot-start-date").val() + " to " + $("#honeypot-end-date").val() + ")",
                fontSize: 13,
                fontColor: "#111"
            },
            plugins: {
                labels: {
                    render: 'percentage',
                    fontColor: '#fff',

                },
                labels: {
                    render: 'percentage',
                    fontColor: '#fff',
                },

                layout: {
                    padding: {
                        left: 0,
                        right: 0,
                        top: 0,
                        bottom: 0
                    }
                },
                legend: {
                    fullWidth: false,
                    position: 'right',
                    display: true,
                    positionDoughnutLabelExtended: 'bottomLeft',
                    labels: {
                        fontSize: 10,
                        usePointStyle: true,
                    }
                },
                positionPDExtended: 'absolute',
            }
        };

        // Creating Pie Chart
        var honeypot_stats_chart = new Chart(honeypot_stats_ctx, {
            type: "doughnut",
            data: honeypot_stats_data,
            options: honeypot_stats_options
        });

        $("#stats-details").on("click", function(e) {
            e.preventDefault();
            let honeypot_start_date = $("#honeypot-start-date").val();
            let honeypot_end_date = $("#honeypot-end-date").val();

            window.open("../log/list?from_time=" + honeypot_start_date + "&to_time=" + honeypot_end_date, "_self");
        });

        $("#stats-refresh").on("click", function(e) {
            e.preventDefault();

            honeypot_stats_chart.options.title.text = "Honeypot Statistics (" + $("#honeypot-start-date").val() + " to " + $("#honeypot-end-date").val() + ")";
            let errors = [];
            let honeypot_start_date = $("#honeypot-start-date").val();
            let honeypot_end_date = $("#honeypot-end-date").val();

            if (errors && errors.length > 0) {
                showError(errors);
                return;
            }

            $.post("./get-stats", {
                    from_time: honeypot_start_date,
                    to_time: honeypot_end_date
                },
                function(res) {
                    if (res.error) {
                        showError(res.error);
                    } else if (res.redirect) {
                        redirectToLogin(res.redirect);
                    } else if (res) {
                        data = [
                            res.data.new_malware,
                            res.data.malicious,
                            res.data.clean,
                            res.data.whitelist,
                        ];


                        if (res.data.new_malware > 0 || res.data.malicious > 0 || res.data.clean > 0 || res.data.whitelist > 0) {
                            emptyData = false;
                        } else {
                            emptyData = true;
                        }

                        if (emptyData) {
                            data.push(1);
                            honeypot_stats_chart.data.labels = [
                                "New Malware",
                                "Malicious",
                                "Clean",
                                "Whitelist",
                                "No Data"
                            ];
                        } else {
                            honeypot_stats_chart.data.labels = [
                                "New Malware",
                                "Malicious",
                                "Clean",
                                "Whitelist",
                            ];
                        }

                        honeypot_stats_chart.data.datasets[0].data = data;

                        honeypot_stats_chart.update();
                    } else {
                        showError("No Honeypot Records Found !!");
                    }
                }, "json").fail(function(response) {
                showError('Error occurred');
            }).always(function() {
                hideLoadingBox();
            });
        });

    });
</script>
