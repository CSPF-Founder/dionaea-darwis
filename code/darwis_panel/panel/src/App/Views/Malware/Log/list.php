<?php

/**
 * Copyright (c) 2022 Cyber Security & Privacy Foundation Pte. Ltd.- All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Cyber Security & Privacy Foundation Pte. Ltd.
 */

use App\Enums\Malware\Verdict;
use Core\View;
use Core\Security\CSRF;


?>

<link rel="stylesheet" type="text/css" href="/resources/vendor/datatables/datatables.min.css" />
<style>
    .tooltip {
        position: relative;
        display: inline-block;
        opacity: 1;
        border-bottom: 1px dotted black;
        font-size: 1.030rem !important;
    }

    .tooltip .tooltiptext {
        visibility: hidden;
        width: 135%;
        max-width: 800px;
        background-color: #555;
        color: #fff;
        text-align: center;
        border-radius: 0px;
        padding: 5px 0;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 0%;
        margin-left: auto;
        opacity: 1;
        transition: opacity 0.9s;
        transition-delay: 3s;
    }

    .tooltip .tooltiptext::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 0;
        /* margin-left: -10px; */
        border-width: 5px;
        border-style: solid;
        width: 100%;
        border-color: #555 transparent transparent transparent;
    }

    .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
    }
</style>


<!-- New theme -->

<div class="row mlt6">
    <div class="col-lg-12 col-sm-12 pb-3 mx-2 fpt14">
        <h3 class="font-weight-bold">Honeypot Stats</h3>
    </div>
</div>


<div class="card pt-2 mt-4">
    <div class="card-header">
        <h5 class="text-center ">
            Honeypot Filter</h5>
        <hr>
    </div>
    <div class="card-body">
        <div class="row mx-auto">
            <div class="col-lg-2">
                From Date
            </div>
            <div class="col-lg-3">
                <input type="date" class="form-control" name="from_time" id="from_time" value="" placeholder="Select Date" autocomplete="off" />
            </div>
            <div class="col-lg-2">
                To Date
            </div>
            <div class="col-lg-3">
                <input type="date" class="form-control" name="to_time" id="to_time" value="" placeholder="Select Date" autocomplete="off" />
            </div>

        </div>
        <div class="row mx-auto mt-2">
            <div class="col-lg-2">
                Search By Verdict
            </div>
            <div class="col-lg-3">
                <select class="form-control" name="verdict" id="verdict">
                    <option value="0">Select All</option>
                    <?php foreach (Verdict::ENUM_LIST as $index => $value) : ?>
                        <option value="<?php View::securePrint($index); ?>" <?php if (isset($verdict) && $verdict == $index) {
                                                                                View::securePrint("selected");
                                                                            } ?>>
                            <?php View::securePrint($value); ?>
                        </option>

                    <?php endforeach; ?>
                    <option value="New Malware">
                        New Malware
                    </option>
                </select>
            </div>
        </div>
        <div class="row mt-2 mx-auto">
            <button class="col-lg-2 btn btn-primary" type="submit" name="filter" id="filter">
                Filter
            </button>

        </div>
    </div>
</div>


<div class="card mt-4 mb-4 p-2">

    <div class="card-body">
        <div class="example">
            <ul class="nav nav-underline" role="tablist">
                <li class="nav-item"><a class="nav-link active" data-coreui-toggle="tab" href="#preview-746" role="tab">
                        <svg class="icon me-2">
                            <use xlink:href="/resources/new-theme/vendor/@coreui/icons/svg/free.svg#cil-media-play"></use>
                        </svg>
                        Honeypot
                    </a></li>
            </ul>
            <div class="tab-content rounded-bottom">
                <div class="tab-pane p-3 active preview" role="tabpanel" id="preview-746">

                    <table id="fetch_honeypot_records" class="table table-striped table-hover table-responsive-sm ">
                        <thead>
                            <tr>
                                <th>Incident Time</th>
                                <th>SHA256</th>
                                <th>Verdict</th>
                                <th>Malware Name</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Over -->
<script src="/resources/vendor/jquery/js/jquery.plugin.min.js"></script>
<script src="/resources/vendor/jquery/js/jquery.datepick.min.js"></script>
<link rel="stylesheet" type="text/css" href="/resources/vendor/datatables-buttons/css/buttons.bootstrap.css" />

<script src="/resources/new-theme/vendor/datatables.net/js/jquery.dataTables.js"></script>
<script src="/resources/new-theme/vendor/datatables.net-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="/resources/new-theme/js/datatables.js"></script>

<!-- responsive data table -->
<link rel="stylesheet" type="text/css" href="/resources/vendor/datatables/responsive/2.3.0/css/responsive.dataTables.min.css" />
<script src="/resources/vendor/datatables/responsive/2.3.0/js/dataTables.responsive.min.js"></script>
<script src="/resources/vendor/datatables-buttons/js/dataTables.buttons.min.js"></script>
<script src="/resources/vendor/datatables-jszip/jszip.min.js"></script>
<script src="/resources/vendor/datatables-pdfmake/pdfmake.min.js"></script>
<script src="/resources/vendor/datatables-pdfmake/vfs_fonts.js"></script>
<script src="/resources/vendor/datatables-buttons/js/buttons.html5.min.js"></script>
<script src="/resources/vendor/datatables-buttons/js/buttons.print.min.js"></script>

<script src="/resources/vendor/other/js/popper.min.js"></script>
<script src="/resources/vendor/jquery/js/bootstrap-datepicker.js"></script>

<script>
    let fromTime = document.getElementById("from_time")
    let toTime = document.getElementById("to_time")

    <?php if (isset($from_time) && $from_time) : ?>
        fromTime.value = "<?php View::securePrint($from_time->format("Y-m-d")); ?>";
    <?php endif; ?>

    <?php if (isset($to_time) && $to_time) : ?>
        toTime.value = "<?php View::securePrint($to_time->format("Y-m-d")); ?>";
    <?php endif; ?>
</script>
<script type="application/javascript">
    load_honeypot_records(); // first load

    function newexportaction(e, dt, button, config) {
        var self = this;
        var oldStart = dt.settings()[0]._iDisplayStart;
        dt.one('preXhr', function(e, s, data) {
            data.start = 0;
            data.length = 2147483647;
            dt.one('preDraw', function(e, settings) {
                if (button[0].className.indexOf('buttons-copy') >= 0) {
                    $.fn.dataTable.ext.buttons.copyHtml5.action.call(self, e, dt, button, config);
                } else if (button[0].className.indexOf('buttons-excel') >= 0) {
                    $.fn.dataTable.ext.buttons.excelHtml5.available(dt, config) ?
                        $.fn.dataTable.ext.buttons.excelHtml5.action.call(self, e, dt, button, config) :
                        $.fn.dataTable.ext.buttons.excelFlash.action.call(self, e, dt, button, config);
                } else if (button[0].className.indexOf('buttons-csv') >= 0) {
                    $.fn.dataTable.ext.buttons.csvHtml5.available(dt, config) ?
                        $.fn.dataTable.ext.buttons.csvHtml5.action.call(self, e, dt, button, config) :
                        $.fn.dataTable.ext.buttons.csvFlash.action.call(self, e, dt, button, config);
                } else if (button[0].className.indexOf('buttons-pdf') >= 0) {
                    $.fn.dataTable.ext.buttons.pdfHtml5.available(dt, config) ?
                        $.fn.dataTable.ext.buttons.pdfHtml5.action.call(self, e, dt, button, config) :
                        $.fn.dataTable.ext.buttons.pdfFlash.action.call(self, e, dt, button, config);
                } else if (button[0].className.indexOf('buttons-print') >= 0) {
                    $.fn.dataTable.ext.buttons.print.action(e, dt, button, config);
                }
                dt.one('preXhr', function(e, s, data) {
                    settings._iDisplayStart = oldStart;
                    data.start = oldStart;
                });
                // setTimeout(dt.ajax.reload, 0);
                return false;
            });
        });
        dt.ajax.reload();
    };

    const MALICIOUS_VERDICT = <?php View::securePrint(Verdict::MALICIOUS); ?>;

    function load_honeypot_records() {
        var ajax_url = "./list";


        filter_data = {};
        let verdict = $("#verdict").val();
        if (verdict) {
            filter_data["verdict"] = verdict;
        }

        if (verdict == "New Malware") {
            filter_data["verdict"] = MALICIOUS_VERDICT;
            filter_data["newly_detected"] = true;
        }

        let from_time = document.getElementById("from_time").value;
        if (from_time) {
            filter_data["from_time"] = from_time;
        }
        let to_time = document.getElementById("to_time").value;
        if (to_time) {
            filter_data["to_time"] = to_time;
        }

        $('#fetch_honeypot_records').DataTable({
            "order": [
                [0, "desc"]
            ],
            dom: 'Blfrtip',
            "bFilter": true,
            buttons: [{
                    "extend": 'copy',
                    "text": 'Copy',
                    "title": 'Honeypot Logs',
                    "action": newexportaction,
                    "className": 'btn  btn-primary mb-2'
                },
                {
                    "extend": 'csv',
                    "text": 'CSV',
                    "title": 'Honeypot Logs',
                    "action": newexportaction,
                    "className": 'btn  btn-primary mb-2'
                },
                {
                    "extend": 'excel',
                    "text": 'Excel',
                    "title": 'Honeypot Logs',
                    "action": newexportaction,
                    "className": 'btn  btn-primary mb-2'
                },
            ],
            responsive: [{
                details: {
                    responsive: true,
                    display: $.fn.dataTable.Responsive.display.childRowImmediate,
                    type: 'none',
                    target: ''
                }
            }],
            "language": [{
                "search": ""
            }],
            initComplete: function() {
                $('.dt-button').removeClass('dt-button');
                $(".dataTables_length").addClass("control-label pt-3");


            },
            "processing": true,
            "language": {
                processing: "<span class='fa-stack fa-lg' ><i class='fa fa-spinner fa-spin fa-stack-2x fa-fw'></i></span>&emsp;Processing ..."
            },
            "serverSide": true,
            "stateSave": true,
            "lengthMenu": [
                [10, 25, 50, 100, -1],
                [10, 25, 50, 100, "All"]
            ],
            "ajax": {
                "url": ajax_url,
                "dataType": "json",
                "type": "POST",
                "data": {
                    "action": "fetch_records",
                    "filter_data": filter_data,
                    <?php CSRF::addAjaxField(); ?>,
                },
                "dataSrc": "records",
            },
            "columns": [

                {
                    "data": "incident_time"
                },
                {
                    "data": "sha256",

                },
                {
                    "data": "verdict"
                },
                {
                    "data": "malware_name"
                },
                {
                    "data": "actions"
                }
            ],

        });
        // $('#fetch_honeypot_records').DataTable().ajax.reload();
        // $('.table').DataTable({

        // });

        $('.dataTables_filter input').attr("placeholder", "Search...");
    }

    $("#filter").click(function() {
        $("#error_log").html("");
        $('#fetch_honeypot_records').DataTable().destroy();
        load_honeypot_records();
    });


    $(document).ready(function() {
        $('body').on('click', '.local-file-path-btn', function(event) {
            $(this).popover('show');
        });
    });


    // $(document).ready(function() {
    //     const popoverTriggerList = document.querySelectorAll('[data-coreui-toggle="popover"]')
    //     const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new coreui.Popover(popoverTriggerEl));
    // });
</script>

<!-- New datatable js -->
